var Utils=Class({$singleton:!0,noop:function(){},asteriskEnd:function(a){return"*"===a.slice(a.length-1)},removeAsteriskEnd:function(a){return this.asteriskEnd(a)?a.slice(0,a.length-1):!1}}),ActionStack=new Class({constructor:function(a,b){this.stack=[];this.channels={};this.defaultAction="function"===typeof a?a:void 0;this.pairedAction="function"===typeof b?b:void 0},addToStack:function(a){if("function"===typeof a.event||"string"===typeof a.event){var b=this.stack.length;this.stack.push({id:b,event:a.event,
data:a.data,context:a.context});return b}return-1},removeFromStack:function(a){return this.stack[a]&&this.stack[a].id===a?(this.stack[a]=null,a):!1},startStack:function(){this.executeStack()},setDefaultAction:function(a){this.defaultAction=a},setPairedAction:function(a){this.pairedAction=a},clearStack:function(a){a||(a=!1);if(!(!0===a&&!1===a)){if(0===this.stack.length){if(!0===a)return this.stack;if(!1===a)return}this.stack=[];if(!0===a)return this.stack}},runStack:function(a){var b=this.stack[a].event,
c=0;if("string"===typeof b)this.stack[a].context||(PubSub.publish(b,this.stack[a].data),c=this.removeFromStack(a),this.pairedAction&&this.pairedAction.call(this.stack[a].context,this.stack[a].data));else if("function"===typeof b)this.stack[a].context?(b.call(this.stack[a].context,this.stack[a].data),this.pairedAction&&this.pairedAction.call(this.stack[a].context,this.stack[a].data)):(b(this.stack[a].data),this.pairedAction&&this.pairedAction(this.stack[a].data)),c=this.removeFromStack(a);else return!1;
if(c===a)return a},executeStack:function(a){switch(!0){case 0<a:if(this.stack[a])return this.runStack(a);this.executeStack(a-1);break;case 0===a||-1===a:if(this.stack[0])return this.runStack(a);this.defaultAction&&this.defaultAction();break;case -1===a:a=!0;for(var b=this.stack.length-1;-1<b;b--)if(this.stack[b]){a=!1;break}(0===b+1||!0===a)&&this.defaultAction&&this.defaultAction();return!1;case !a&&0!==a:a=this.stack.length-1,0!==a&&!a&&(a=-1),this.executeStack(a)}},opened:function(a,b,c,d){this.channels&&
(this.channels[a]&&this.stack[this.channels[a]])&&this.removeFromStack(this.channels[a]);this.channels[a]=this.addToStack({event:b,data:c,context:d});return this.channels[a]},close:function(a){this.channels&&-1<this.channels[a]&&(this.executeStack(this.channels[a]),this.channels[a]=-1)},closed:function(a){this.channels&&-1<this.channels[a]&&(this.removeFromStack(this.channels[a]),this.channels[a]=-1)}}),State=new Class({constructor:function(a,b,c){this.state=a;this.secondState="";b&&(this.initCallback=
b);c&&(this.endCallback=c)},deleteInitCB:function(){this.initCallback=null},deleteEndCB:function(){this.endCallback=null},setInitCB:function(a){this.initCallback=a},setEndCB:function(a){this.endCallback=a},changeName:function(a){this.state=a}}),StateMachine=Class({$singleton:!0,main:function(){this.modules={};this.escapeStack=new ActionStack(function(){StateMachine.escapeStack.stack=[];var a=$("input:focus, select:focus, textarea:focus");1===a.length?a.first().trigger("blur"):1<a.length&&a.each(function(a,
c){c.trigger("blur")});$("body").trigger("click")})},registerModule:function(a,b,c){if(this.modules[a])return!1;this.modules[a]={};this.modules[a].name=a;this.modules[a].states={};c&&(this.modules[a].state=c);c=b.length;for(var d=0,d=0;d<c;d++)this.createState(a,b[d].state,b[d].initCB,b[d].endCB);return!0},createState:function(a,b,c,d){if(this.modules[a].states[b])return!1;this.modules[a].states[b]=new State(b,c,d);return!0},deleteModule:function(a){this.modules[a]&&delete this.modules[a]},getState:function(a){return this.modules[a].state},
changeState:function(a,b,c){var d=this.modules[a].state;this.modules[a].states[d]&&this.modules[a].states[d].endCallback&&(c?this.modules[a].states[d].endCallback(c):this.modules[a].states[d].endCallback());this.modules[a].state=b;this.modules[a].states[b]&&this.modules[a].states[b].initCallback&&(c?this.modules[a].states[b].initCallback(c):this.modules[a].states[b].initCallback())},getSecondState:function(a){return this.modules[a].secondState},setSecondState:function(a,b,c){if(""===this.modules[a].secondState)this.modules[a].secondState=
b,this.modules[a].states[b]&&this.modules[a].states[b].initCallback(c);else{var d=this.modules[a].secondState;this.modules[a].states[d]&&(this.modules[a].states[d].endCallback(c),this.modules[a].secondState=b,this.modules[a].states[b]&&this.modules[a].states[b].initCallback(c))}}}),PubSub=Class(function(){return{main:function(){this.modules=[];this.channels={};this.channelsList=[];this.subscriptions={}},$singleton:!0,$statics:{async:function(a){setTimeout(function(){a()},0)},hasSubscribers:function(a){return 0<
this.channels[a].subscribers.length}},createChannel:function(a){if(!this.channels[a]){this.channels[a]=new Channel(a,!0);this.channelsList.push(a);for(var b=this.channels[a].subChannels.length,c=0,c=0;c<b;c++)this.channels[this.channels[a].subChannels[c]]||(this.channels[this.channels[a].subChannels[c]]=new Channel(this.channels[a].subChannels[c],!1),this.channelsList.push(this.channels[a].subChannels[c]))}return this},deliver:function(a,b){for(var c=this.channels[a].subscribers.length,d=0,d=0;d<
c;d++)this.channels[a].subscribers[d]&&this.channels[a].subscribers[d].callback(b)},publish:function(a,b){if(this.channels[a]&&this.channels[a].subscribers&&this.channels[a].subscribers.length){var c=this.channels[a].subscribers.length,d;for(d=0;d<c;d++)this.channels[a].subscribers[d]&&this.channels[a].subscribers[d].callback(b);if(this.channels[a].subChannels.length){c=this.channels[a].subChannels.length;for(d=0;d<c;d++)this.deliver(this.channels[a].subChannels[d],b)}}},subscribe:function(a,b){if(Utils.asteriskEnd(a)){var c=
a;a=c.length&&Utils.asteriskEnd(c)?Utils.removeAsteriskEnd(c):void 0}this.channels[a]||this.createChannel(a);return this.channels[a].subscribers?(this.channels[a].subscribers.push({callback:b}),this.channels[a].subscribers.length-1):null},unsubscribe:function(a,b){this.channels[a].subscribers[b]&&(this.channels[a].subscribers[b]=0);return this}}}),Channel=Class({constructor:function(a,b){this.channel=a;this.original=b;this.subscribers=[];this.splitter=":";this.original&&(this.subChannels=[],this.parseTopics())},
deleteChannel:function(){this.changeChannel=this.clearSubs=this.parseTopics=this.subChannels=this.splitter=this.subscribers=this.original=this.channel=null;return!0},clearSubs:function(){this.subscribers=[]},changeChannel:function(a){PubSub.publish("pubsub:channels:changeChannel",{prev:this.channel,next:a},!0);this.channel=a},parseTopics:function(){var a=this.channel.indexOf(":"),b=this.channel.indexOf(".");-1<a?this.splitter=":":-1<b&&(this.splitter=".");for(var a=this.channel.split(this.splitter),
b=a.length,c="",d=0,e=0,d=0;d<b-1;d++){c="";for(e=0;e<=d;e++)c=0===e?a[e]:c+this.splitter+a[e];this.subChannels.push(c)}}}),TaskQueue=new Class(function(){return{queue:[],data:{},main:function(){},constructor:function(a,b,c){"array"===typeof a&&"object"===typeof b&&(this.queue=a,this.data=b,c&&this.start())},addTask:function(a){!0===a.async?this.data[a.name]={task:a.task,params:a.params,async:a.async,timeout:a.timeout}:!1===a.async&&(this.data[a.name]={task:a.task,params:a.params,async:a.async});
return this},removeTask:function(a){this.data[a]&&(this.data[a]=void 0);for(var b=this.queue.length,c=0,c=0;c<b;c++)this.queue[c]===a&&this.queue.splice(c,1);return this},enQ:function(a){this.data[a]&&this.queue.push(a);this.active&&1===this.queue.length&&this.start(0);return this},deQ:function(a){a=this.queue.indexOf(a);-1<a&&this.queue.splice(a,1);return this},deQLast:function(a){a=this.queue.lastIndexOf(a);-1<a&&this.queue.splice(a,1);return this},start:function(){if(this.queue[0]){var a=this.data[this.queue[0]];
a&&a.task&&(this.active=!1===a.async?!0:!1,a.params?a.task(a.params):a.task(),this.nextTask(0))}else this.active=!0},stop:function(){this.active=!1},clearQueue:function(){this.queue=[];return this},nextTask:function(a){this.queue.splice(a,1);if(this.queue[a]&&this.active){var b=this.queue[a];this.data[b]&&this.data[b].task&&(this.data[b].params?this.data[b].task(this.data[b].params):this.data[b].task(),this.nextTask(a))}}}});
